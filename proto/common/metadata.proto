syntax = "proto3";

package flare.common.v1;

import "google/protobuf/timestamp.proto";

// -----------------------------------------------------------------------------
// Trace / Actor / Device 信息
// -----------------------------------------------------------------------------

// 追踪上下文（用于分布式追踪）
message TraceContext {
  string trace_id = 1;        // 追踪ID（全局唯一）
  string span_id = 2;         // 当前Span ID
  string parent_span_id = 3;  // 父Span ID（根Span为空）
  string sampled = 4;         // 采样标志（yes/no/force）
  map<string, string> tags = 5; // 追踪标签
}

// 操作者类型
enum ActorType {
  ACTOR_TYPE_UNSPECIFIED = 0;
  ACTOR_TYPE_USER = 1;         // 普通用户
  ACTOR_TYPE_SERVICE = 2;      // 服务账号
  ACTOR_TYPE_TENANT_ADMIN = 3; // 租户管理员
  ACTOR_TYPE_SYSTEM = 4;       // 系统账号
  ACTOR_TYPE_GUEST = 5;        // 访客
}

// 操作者上下文（用于权限校验和审计）
message ActorContext {
  string actor_id = 1;              // 操作者ID（必需）
  ActorType type = 2;               // 操作者类型（必需）
  repeated string roles = 3;         // 角色列表（RBAC）
  map<string, string> attributes = 4; // 扩展属性
}

// 设备上下文（用于设备管理和统计）
message DeviceContext {
  string device_id = 1;              // 设备ID（必需）
  string platform = 2;               // 设备平台（ios/android/web/pc等）
  string model = 3;                  // 设备型号
  string os_version = 4;             // 操作系统版本
  string app_version = 5;            // 应用版本（语义化版本号）
  string locale = 6;                 // 语言环境（BCP 47格式）
  string timezone = 7;               // 时区（IANA格式）
  string ip_address = 8;             // IP地址（IPv4/IPv6）
  map<string, string> attributes = 9; // 扩展属性
}

// -----------------------------------------------------------------------------
// 请求上下文
// -----------------------------------------------------------------------------

// 请求上下文（所有业务接口请求的必需字段）
message RequestContext {
  string request_id = 1;              // 请求ID（必需，UUID格式）
  TraceContext trace = 2;             // 追踪上下文（可选）
  ActorContext actor = 3;              // 操作者上下文（必需）
  DeviceContext device = 4;           // 设备上下文（可选）
  string channel = 5;                  // 请求渠道（websocket/grpc/http/quic）
  string user_agent = 6;              // 用户代理（HTTP User-Agent格式）
  map<string, string> attributes = 7;  // 扩展属性
}

// -----------------------------------------------------------------------------
// 租户 / 业务上下文
// -----------------------------------------------------------------------------

// 租户上下文（所有业务接口请求的必需字段，用于多租户隔离）
message TenantContext {
  string tenant_id = 1;               // 租户ID（必需）
  string business_type = 2;           // 业务类型（im/customer_service/ai_chat等）
  string environment = 3;             // 环境（production/staging/development）
  string organization_id = 4;         // 组织ID
  map<string, string> labels = 5;     // 标签（用于分类和过滤）
  map<string, string> attributes = 6;  // 扩展属性
}

// -----------------------------------------------------------------------------
// 通用分页 / 过滤 / 排序
// -----------------------------------------------------------------------------

// 排序方向
enum SortDirection {
  SORT_DIRECTION_UNSPECIFIED = 0;
  SORT_DIRECTION_ASC = 1;   // 升序
  SORT_DIRECTION_DESC = 2;  // 降序
}

// 排序表达式
message SortExpression {
  string field = 1;                    // 排序字段名
  SortDirection direction = 2;          // 排序方向
}

// 过滤操作符
enum FilterOperator {
  FILTER_OPERATOR_UNSPECIFIED = 0;
  FILTER_OPERATOR_EQ = 1;        // 等于
  FILTER_OPERATOR_NE = 2;        // 不等于
  FILTER_OPERATOR_IN = 3;        // 包含于
  FILTER_OPERATOR_NOT_IN = 4;    // 不包含于
  FILTER_OPERATOR_GT = 5;        // 大于
  FILTER_OPERATOR_GE = 6;        // 大于等于
  FILTER_OPERATOR_LT = 7;        // 小于
  FILTER_OPERATOR_LE = 8;        // 小于等于
  FILTER_OPERATOR_CONTAINS = 9;  // 包含（字符串）
}

// 过滤表达式（支持多条件AND组合）
message FilterExpression {
  string field = 1;                    // 过滤字段名
  FilterOperator op = 2;               // 过滤操作符
  repeated string values = 3;           // 过滤值列表
}

// 时间范围（用于时间范围过滤）
message TimeRange {
  google.protobuf.Timestamp start_time = 1;  // 起始时间（包含，必需）
  google.protobuf.Timestamp end_time = 2;    // 结束时间（包含，必需）
}

// 分页信息（用于分页导航）
message Pagination {
  string cursor = 1;          // 下一页游标（空表示没有更多数据）
  int32 limit = 2;            // 每页数量限制（1-1000，建议20-100）
  bool has_more = 3;          // 是否有更多数据
  string previous_cursor = 4; // 上一页游标（可选）
  int64 total_size = 5;       // 总记录数（可选，可能影响性能）
}

// -----------------------------------------------------------------------------
// 媒资与审计
// -----------------------------------------------------------------------------

// 媒体附件（用于消息中的媒体文件）
message MediaAttachment {
  string file_id = 1;                  // 文件ID（必需）
  string file_name = 2;                // 文件名
  string mime_type = 3;                 // MIME类型
  int64 size = 4;                      // 文件大小（字节）
  string url = 5;                      // 文件访问URL
  string cdn_url = 6;                  // CDN加速URL（可选）
  int64 duration_ms = 7;               // 时长（毫秒，仅音频/视频）
  string checksum = 8;                 // 校验和（SHA256/MD5）
  map<string, string> metadata = 9;     // 扩展元数据
}

// 审计上下文（用于合规和安全审计）
message AuditContext {
  ActorContext actor = 1;                        // 操作者（必需）
  google.protobuf.Timestamp operated_at = 2;     // 操作时间（必需）
  string reason = 3;                            // 操作原因
  map<string, string> metadata = 4;             // 扩展元数据
}
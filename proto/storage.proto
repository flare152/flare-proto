syntax = "proto3";

package flare.storage.v1;

import "google/protobuf/timestamp.proto";
import "common/errors.proto";
import "common/metadata.proto";
import "common/message.proto";

// -----------------------------------------------------------------------------
// 存储查询服务
// -----------------------------------------------------------------------------
// 职责：消息查询、删除、撤回等核心能力（只读和命令操作）
// 依赖：TimescaleDB（时序数据库）、Redis（缓存）
// 注意：消息写入统一通过 MessageService.SendMessage → Kafka → Storage Writer
//

// -----------------------------------------------------------------------------
// 枚举定义
// -----------------------------------------------------------------------------

enum ClearType {
  CLEAR_ALL = 0;
  CLEAR_BEFORE_MESSAGE = 1;
  CLEAR_BEFORE_TIME = 2;
}

enum MessageType {
  MESSAGE_TYPE_UNSPECIFIED = 0;
  MESSAGE_TYPE_TEXT = 1;      // 文本消息
  MESSAGE_TYPE_BINARY = 2;    // 二进制消息
  MESSAGE_TYPE_CUSTOM = 3;    // 自定义消息
}

enum VisibilityStatus {
  VISIBLE = 0;   // 可见
  HIDDEN = 1;     // 隐藏（软删除）
  DELETED = 2;    // 已删除（永久删除）
}

// -----------------------------------------------------------------------------
// 数据模型
// -----------------------------------------------------------------------------
// 注意：Message 定义已迁移到 common/message.proto
// 所有服务统一使用 flare.common.v1.Message
// 保留以下枚举和辅助消息用于向后兼容

// 失败的消息详情
message FailedMessage {
  string message_id = 1;
  flare.common.v1.ErrorCode code = 2;
  string error_message = 3;
}

// -----------------------------------------------------------------------------
// 写入相关消息
// -----------------------------------------------------------------------------

message StoreMessageRequest {
  string session_id = 1;
  flare.common.v1.Message message = 2;  // 使用 common 中的统一 Message 定义
  bool sync = 3;
  flare.common.v1.RequestContext context = 4;
  flare.common.v1.TenantContext tenant = 5;
  map<string, string> tags = 6;
}

message StoreMessageResponse {
  bool success = 1;
  string message_id = 2;
  string error_message = 3;
  flare.common.v1.RpcStatus status = 4;
}

message BatchStoreMessageRequest {
  repeated StoreMessageRequest messages = 1;
}

message BatchStoreMessageResponse {
  int32 success_count = 1;
  int32 fail_count = 2;
  repeated string message_ids = 3;
  repeated FailedMessage failures = 4;
  flare.common.v1.RpcStatus status = 5;
}

// -----------------------------------------------------------------------------
// 查询相关消息
// -----------------------------------------------------------------------------

message QueryMessagesRequest {
  string session_id = 1;
  int64 start_time = 2;
  int64 end_time = 3;
  int32 limit = 4;
  string cursor = 5;
  flare.common.v1.RequestContext context = 6;
  flare.common.v1.TenantContext tenant = 7;
  flare.common.v1.Pagination pagination = 8;
}

message QueryMessagesResponse {
  repeated flare.common.v1.Message messages = 1;  // 使用 common 中的统一 Message 定义
  string next_cursor = 2;
  bool has_more = 3;
  flare.common.v1.Pagination pagination = 4;
  flare.common.v1.RpcStatus status = 5;
}

message SearchMessagesRequest {
  flare.common.v1.RequestContext context = 1;
  flare.common.v1.TenantContext tenant = 2;
  repeated flare.common.v1.FilterExpression filters = 3;
  repeated flare.common.v1.SortExpression sort = 4;
  flare.common.v1.Pagination pagination = 5;
  flare.common.v1.TimeRange time_range = 6;
}

message SearchMessagesResponse {
  repeated flare.common.v1.Message messages = 1;  // 使用 common 中的统一 Message 定义
  flare.common.v1.Pagination pagination = 2;
  flare.common.v1.RpcStatus status = 3;
}

message GetMessageRequest {
  flare.common.v1.RequestContext context = 1;
  flare.common.v1.TenantContext tenant = 2;
  string message_id = 3;
}

message GetMessageResponse {
  flare.common.v1.Message message = 1;  // 使用 common 中的统一 Message 定义
  flare.common.v1.RpcStatus status = 2;
}

// -----------------------------------------------------------------------------
// 删除 / 撤回 / 清理相关消息
// -----------------------------------------------------------------------------

message DeleteMessageRequest {
  string session_id = 1;
  repeated string message_ids = 2;
  flare.common.v1.RequestContext context = 3;
  flare.common.v1.TenantContext tenant = 4;
}

message DeleteMessageResponse {
  bool success = 1;
  int32 deleted_count = 2;
  flare.common.v1.RpcStatus status = 3;
}

message RecallMessageRequest {
  string message_id = 1;
  string operator_id = 2;
  string reason = 3;
  int32 recall_time_limit_seconds = 4;
  flare.common.v1.RequestContext context = 5;
  flare.common.v1.TenantContext tenant = 6;
}

message RecallMessageResponse {
  bool success = 1;
  string error_message = 2;
  google.protobuf.Timestamp recalled_at = 3;
  flare.common.v1.RpcStatus status = 4;
}

message DeleteMessageForUserRequest {
  string message_id = 1;
  string user_id = 2;
  bool permanent = 3;
  flare.common.v1.RequestContext context = 4;
  flare.common.v1.TenantContext tenant = 5;
}

message DeleteMessageForUserResponse {
  bool success = 1;
  int32 deleted_count = 2;
  flare.common.v1.RpcStatus status = 3;
}

message ClearSessionRequest {
  string session_id = 1;
  string user_id = 2;
  ClearType clear_type = 3;
  string clear_before_message_id = 4;
  google.protobuf.Timestamp clear_before_time = 5;
  flare.common.v1.RequestContext context = 6;
  flare.common.v1.TenantContext tenant = 7;
}

message ClearSessionResponse {
  bool success = 1;
  string error_message = 2;
  int32 cleared_count = 3;
  google.protobuf.Timestamp cleared_at = 4;
  flare.common.v1.RpcStatus status = 5;
}

message MarkMessageReadRequest {
  string message_id = 1;
  string user_id = 2;
  flare.common.v1.RequestContext context = 3;
  flare.common.v1.TenantContext tenant = 4;
}

message MarkMessageReadResponse {
  bool success = 1;
  string error_message = 2;
  google.protobuf.Timestamp read_at = 3;
  google.protobuf.Timestamp burned_at = 4;
  flare.common.v1.RpcStatus status = 5;
}

// -----------------------------------------------------------------------------
// 元数据操作相关消息
// -----------------------------------------------------------------------------

message SetMessageAttributesRequest {
  flare.common.v1.RequestContext context = 1;
  flare.common.v1.TenantContext tenant = 2;
  string message_id = 3;
  map<string, string> attributes = 4;
  repeated string tags = 5;
}

message SetMessageAttributesResponse {
  flare.common.v1.RpcStatus status = 1;
}

message ListMessageTagsRequest {
  flare.common.v1.RequestContext context = 1;
  flare.common.v1.TenantContext tenant = 2;
}

message ListMessageTagsResponse {
  repeated string tags = 1;
  flare.common.v1.RpcStatus status = 2;
}

message ExportMessagesRequest {
  flare.common.v1.RequestContext context = 1;
  flare.common.v1.TenantContext tenant = 2;
  string session_id = 3;
  flare.common.v1.TimeRange time_range = 4;
  repeated flare.common.v1.FilterExpression filters = 5;
}

message ExportMessagesResponse {
  string export_task_id = 1;
  flare.common.v1.RpcStatus status = 2;
}

// -----------------------------------------------------------------------------
// 服务定义
// -----------------------------------------------------------------------------

// 存储查询服务 - 由 flare-storage-reader 实现
// 
// 设计说明：
// - 消息写入统一通过 MessageService.SendMessage → Kafka → Storage Writer
// - 本服务只提供查询和命令操作（删除、撤回、标记已读等）
// - 所有操作都经过 Message Orchestrator 的 Hook 校验
service StorageReaderService {
  // 查询会话消息（支持时间范围和分页）
  rpc QueryMessages(QueryMessagesRequest) returns (QueryMessagesResponse);

  // 搜索消息（支持复杂过滤和排序）
  rpc SearchMessages(SearchMessagesRequest) returns (SearchMessagesResponse);

  // 获取单条消息
  rpc GetMessage(GetMessageRequest) returns (GetMessageResponse);

  // 删除消息（支持批量删除）
  rpc DeleteMessage(DeleteMessageRequest) returns (DeleteMessageResponse);

  // 撤回消息（支持撤回时间限制）
  rpc RecallMessage(RecallMessageRequest) returns (RecallMessageResponse);

  // 为用户删除消息（软删除，仅对指定用户隐藏）
  rpc DeleteMessageForUser(DeleteMessageForUserRequest) returns (DeleteMessageForUserResponse);

  // 清理会话消息（支持三种清理模式）
  rpc ClearSession(ClearSessionRequest) returns (ClearSessionResponse);

  // 标记消息已读（支持阅后即焚）
  rpc MarkMessageRead(MarkMessageReadRequest) returns (MarkMessageReadResponse);

  // 设置消息属性（属性和标签）
  rpc SetMessageAttributes(SetMessageAttributesRequest) returns (SetMessageAttributesResponse);

  // 列出消息标签
  rpc ListMessageTags(ListMessageTagsRequest) returns (ListMessageTagsResponse);

  // 导出消息（异步导出，支持时间范围和过滤）
  rpc ExportMessages(ExportMessagesRequest) returns (ExportMessagesResponse);
}
